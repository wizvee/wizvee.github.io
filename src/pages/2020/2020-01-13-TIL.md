---
type: 'post'
title: '2020-01-14 TIL'
date: '2020-01-14'
tags: ['TIL', 'Linux', 'Jenkins']
---

## 문제 해결

초보 개발자의 좌충우돌 서버 경험기입니다. 😭

### Setting Jenkins

```bash
$ sudo apt-get update

# 1. open JDK 설치
$ sudo apt-get install openjdk-8-jdk

# 2. Jenkins 설치
$ sudo apt-get install jenkins

# 3. Jenkins 시작
$ sudo systemctl start jenkins
```

### JAVA_HOME

```bash
$ update-alternatives --display java
java - auto mode
  link best version is /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
  link currently points to /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
...
```

`update-alternatives --display java`를 명령을 통해 확인할 수 있습니다. **link currently points to** 뒤에 있는 주소가 `JAVA_HOME`이에요.

이제 주소를 알았으니 환경 변수로 설정합니다.

```bash
$ nano /etc/environment

# /etc/environment
JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64"

# environment 적용
$ source /etc/environment
```

### Github + Jenkins

Github과 jenkins를 `ssh` 연동 방식을 통하여 연동하는 방법입니다.

우선 jenkins가 설치된 서버에서 `ssh`를 생성합니다.

```bash
$ sudo su -s /bin/bash jenkins
$ ssh-keygen
```

그리고 생성한 키 중 public key를 jenkins로 연동하고 싶은 github의 repository에 등록합니다. `Settings`의 `Deploy keys`에서 등록할 수 있습니다. 그리고 private key는 jenkins에 등록합니다. `Credentials` 메뉴에서 등록할 수 있습니다.

```bash
# public key 조회
$ cat /var/lib/jenkins/.ssh/[key name].pub

# private key 조회
$ cat /var/lib/jenkins/.ssh/[key name]
```

이후 jenkins에서 job을 생성할 때에 해당 키를 사용하면 됩니다! 😊

### Run jar files as service

Jenkins와 git을 연동해 서버에 `jar` 파일을 올리는 부분까지는 어찌어찌 성공. 이후 `jar` 파일을 어떻게 실행할 것인지 알아보다가 우선 서버에 서비스로 등록하는 방법을 찾았어요.

우선 리눅스 서버에 사용자 정의 서비스를 등록합니다.

```bash
# /etc/systemd/system에 등록할 service파일 생성
$ nano /etc/systemd/system/myapp.service

# myapp.service
[Unit]
Description = my app!
After = network.target

[Service]
ExecStart = /bin/bash -c "exec java -jar [target file]"

User = root
Group = root

[Install]
WantedBy = multi-user.target

# myapp.service파일 저장 후 서비스로 등록
$ systemctl enable myapp.service

# myapp 서비스 실행
$ systemctl start myapp
```

여기까지는 순조롭게 성공. 그러나 jenkins로 서비스를 실행하려고 하면 계속 `sudo: no tty present and no askpass program specified` 에러가 뜨더라고요. 🤣 해당 에러는 `jenkins`라는 유저에 권한이 부여되지 않았기 때문이라고 합니다. 아래와 같이 해결했어요.

```bash
# /etc/sudoers파일 수정
$ nano /etc/sudoers

# /etc/sudoers
...
# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL
jenkins ALL=(ALL) NOPASSWD: ALL
```

`/etc/sudoers` 파일에 `jenkins ALL=(ALL) NOPASSWD: ALL` 문구를 추가하면 해결됩니다. 해당 내용은 [Jenkins sudo: ~](https://stackoverflow.com/questions/37603621/jenkins-sudo-no-tty-present-and-no-askpass-program-specified-with-nopasswd)를 참고하였습니다.

### Linux Commands

`apt`

```bash
# repository index 갱신
$ sudo apt-get update

# package upgrade
$ sudo apt-get upgrade

# auto remove package
$ sudo apt-get autoremove

# install package
$ sudo apt-get install [package name]

# remove package
$ sudo apt-get remove [package name]
```
